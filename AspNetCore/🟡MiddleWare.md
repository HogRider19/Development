Одна из основных задач приложения - это обработка входящих запросов. Обработка запроса в ASP.NET Core устроена по принципу конвейера, который состоит из компонентов. Подобные компоненты еще называются middleware.

При получении запроса сначала данные запроса получает первый компонент в конвейере. После обработки запроса компонент middleware он может закончить обработку запроса - такой компонент еще называется терминальным компонентом. 

Либо он может передать данные запроса для обработки далее по конвейеру - следующему в конвейере компоненту и так далее. После обработки запроса последним компонентом, данные запроса возвращаются к предыдущему компоненту.

![[Pasted image 20231209160752.png]]

Компоненты middleware встраиваются с помощью методов расширений `Run`, `Map` и `Use` интерфейса IApplicationBuilder. Класс WebApplication реализует данный интерфейс и поэтому позволяет добавлять компоненты middleware с помощью данных методов.

Каждый компонент middleware может быть определен как метод встроенный inline компонент, либо может быть вынесен в отдельный класс.

Компоненты создаются один раз и существуют в течение всего жизненного цикла приложения. То есть для обработки запросов используются одни и те же компоненты.

При получении запроса сервер формирует на его основе объект HttpContext, которые содержит всю необходимую информацию о запросе. Эта информация посредством объекта HttpContext передается всем компонентам middleware в приложении.

**Task RequestDelegate(HttpContext context, next)** - делегат определения middleware.

Для создания компонентов middleware используется делегат RequestDelegate, который выполняет некоторое действие и принимает контекст запроса - объект HttpContext. Контекст запроса инкапсулирует в себе информацию о забросе в виде свойств:

**Connection** - представляет информацию о подключении данного запроса.
**Features** - получает коллекцию HTTP-функциональностей текущего запроса.
**Items** - получает или устанавливает коллекцию пар для хранения некоторых данных.
**Request** - возвращает объект HttpRequest, который хранит информацию о запросе.
**RequestServices** - объект IServiceProvider для работы с зарегистрированными сервисами.
**Response** - возвращает объект HttpResponse, который позволяет управлять ответом.
**TraceIdentifier** - представляет идентификатор запроса для логов трассировки.
**WebSockets** - возвращает объект для управления подключениями WebSocket.
**User** - представляет пользователя, ассоциированного с этим запросом.
**Session** - хранит данные сессии для текущего запроса.

Стоит отметить, что ASP.NET Core уже по умолчанию предоставляет ряд встроенных компонентов middleware для часто встречающихся задач:

**Authentication** - предоставляет поддержку аутентификации.
**Authorization** - предоставляет поддержку авторизации.
**Cookie Policy** - отслеживает согласие пользователя на хранение информации.
**CORS** - обеспечивает поддержку кроссдоменных запросов политики CORS.
**DeveloperExceptionPage** - генерирует веб-страницу с информацией об ошибке.
**Diagnostics** - набор middleware, для диагностики при разработке приложения.
**HealthCheck** - проверяет работоспособность приложения на определенном url.
**HTTPSRedirection** - перенаправляет все запросы HTTP на HTTPS протоколов.

**MVC** - обеспечивает функционал фреймворка MVC.
**RequestLocalization** - обеспечивает поддержку локализации.
**ResponseCaching** - позволяет кэшировать результаты запросов.
**ResponseCompression** - обеспечивает сжатие ответа клиенту.
**URLRewrite** - предоставляет функциональность URL Rewriting.
**EndpointRouting** - предоставляет механизм маршрутизации.
**Session** - предоставляет поддержку сессий.
**StaticFiles** - предоставляет поддержку обработки статических файлов.
**WebSockets** - добавляет поддержку протокола WebSockets.

Для встраивания этих компонентов в конвейер обработки запроса для интерфейса IApplicationBuilder определены методы расширения типа `UseXXX`.

---

**app.Run(ReqDel)** - добавляет терминальный компонент, который завершает обработку запроса. Поэтому соответственно он не вызывает никакие другие компоненты и обработку запроса дальше - следующим в конвейере компонентам не передает.

Прежде всего, не стоит путать метод Run(), который определен в классе WebApplication и который запускает приложение, и метод расширения Run(), который встраивает компонент middleware. Это два разных метода, которые выполняют разные задачи.

**app.Use(RedDel)** - добавляет middleware с вызова следующего **await next.Invoke(context)** - передача контекста следующему middeware

**app.Map(path, builder=>)** - применяется для создания ветки конвейера, которая будет обрабатывать запрос по определенному пути

**app.UseWhen(context=>bool, buider=>)** - на основании некоторого условия позволяет создать ответвление конвейера при обработке запроса

**app.MapWhen(context=>bool, buider=>)** - аналогичен UseWhen, но в отличии от него не может передавать контекст в основную ветку

---

## Class Middleware:

**app.UseMiddleware()** - добавление middleware

### Класс middleware должен иметь:

1. Конструктор , который принимает RequestDelegate (next)
2. InvokeAsync, который принимает HttpContext