Ключевой сущностью в SignalR, через которую клиенты обмениваются сообщениями с сервером и между собой, является hub. Hub представляет некоторый класс, который унаследован от абстрактного класса Microsoft.AspNetCore.SignalR.Hub

Класс Hub может определять различные методы с различными параметрами, однако клиент может обращаться только к публичным методам Hub.

---

### HubOptions

**AddSignalR(Action cnf)** - подключение сервисов SignalR

**ClientTimeoutInterval** - Определяет время, в течение которого клиент должен отправить серверу сообщение. Если в течение данного времени никаких сообщений от клиента на сервер не пришло, то сервер закрывает соединение. По умолчанию равно 30 секунд

**HandshakeTimeout** - после подключения к серверу клиент должен отправить серверу в качестве первого сообщения - HandshakeRequest. Это свойство устанавливает допустимое время таймаута, которое может пройти до получения от клиента первого сообщения об установки соединения. По умолчанию равно 15 секунд.

**KeepAliveInterva**l - если в течение этого периода сервер не отправит никаких сообщений, то автоматически отправляется ping-сообщение для поддержания подключения открытым. При изменении этого свойства Microsoft рекомендует изменить на стороне клиента параметр serverTimeoutInMilliseconds, которое рекомендуется устанавливать в два раза больше, чем KeepAliveInterval. По умолчанию равно 15 секунд

**SupportedProtocols** - определяет поддерживаемые протоколы. По умолчанию поддерживаются все протоколы.

**EnableDetailedErrors** - при значении true возвращает клиенту детальное описание возникшей ошибки. Поскольку подобные сообщения могут содержать критически важную для безопасности информацию, то по умолчанию имеет значение false.

**StreamBufferCapacity** - определяет максимальный размер буфера для входящего потока клиента. По умолчанию равно 10.

**MaximumReceiveMessageSize** - определяет максимальный размер для входящего сообщения. По умолчанию - 32 кб

**MaximumParallelInvocationsPerClient** - определяет максимальное количество методов Hub, которые клиент может вызвать параллельно. По умолчанию равно 1.

---

### HttpConnectionDispatcherOptions

**app.MapHub("/path")** - middleware обработки конкретного Hub

Перегрузка метода MapHub дополнительно принимает делегат с параметром типа HttpConnectionDispatcherOptions, благодаря чему мы можем настроить различные настройки подключения

**ApplicationMaxBufferSize** - максимальный размер буфера в байтах, в который сервер помещает получаемые от клиента данные (64 кб)

**AuthorizationData** - представляет список объектов IAuthorizeData, которые определяют, авторизован ли клиент для подключения к хабу.

**TransportMaxBufferSize** - максимальный размер буфера в байтах, в который сервер помещает данные для отправки клиенту (64 кб)

**MinimumProtocolVersion** - минимальная версия протокола. Применяется, чтобы отсеить клиентов определенных версий

**Transports** - представляет битовую маску из значений перечисления HttpTransportType, которая устанавливает допустимые типы транспорта. По умолчанию применяются все типы транспорта

**LongPolling** - представляет объект LongPollingOptions, который настраивает транспорт LongPolling. Этот класс имеет только свойство PollTimeout, которое устанавливает периодичность опроса (90с)

**WebSockets** - представляет объект WebSocketOptions, который настраивает транспорт WebSocket.

---

### HubCallerContext

В классе Hub определено свойство Context, которое представляет тип HubCallerContext и который позволяет нам получить некоторую информацию о подключении к Hub

## Свойства HubCallerContext:

1. **ConnectionId** - возвращает уникальный идентификатор подключения в виде строки.
2. **ConnectionAborted** - возвращает объект CancellationToken, который извещает о закрытии подключения
3. **User** - возвращает объект ClaimsPrincipal, ассоциированный с текущим пользователем. По сути это аналог свойства HttpContext.User, которое доступно в констроллерах
4. **UserIdentifier** - возвращает идентификатор пользователя. По умолчанию индентификатор пользователя представляет клейм ClaimTypes.NameIdentifier объекта ClaimsPrincipal, который ассоциирован с данным подключением.
5. **Items** - возвращает словарь значений, ассоциированных с текущим подключением. Данный словарь позволяет хранить данные для определенного клиента между его запросами
6. **Features** - возвращает коллекцию возможностей HTTP, ассоциированных с текущим подключением
7. **Abort()** - принудительно завершает текущее подключение
8. **GetHttpContext()** - возвращает объект HttpContext для текущего подключения или null, если подключение не ассоциировано HTTP.

---

### Подключение и отключение клиентов

Класс Hub определяет два метода, которые мы можем переопределить в классах-наследниках:

**OnConnectedAsync()** - срабатывает при подключении нового клиента **OnDisconnectedAsync(exc)** - срабатывает при отключении клиента

---

### Clients

Для взаимодействия с клиентами в классе Hub определено свойство Clients. Оно представляет всех подключенных клиентов в виде объекта IHubCallerClients. Если в классе Hub необходимо вызвать на клиенте функцию и отправить ей некоторые данные, то мы можем использовать данный объект

У объекта Clients есть следующие свойства:

**All** - представляет всех подключенных клиентов **Caller** - представляет только текущего обратившегося клиента **Others** - представляет всех клиентов за исключением текущего клиента

У объекта Clients есть следующие методы:

**AllExcept(List Ids)** - представляет всех клиентов не в ids **Client(string connectionId)** - вызывает метод у клиента по id **Clients(List Ids)** - вызывает метод у клиентов по ids **Group(string groupName)** - вызывает метод у клиентов группы **Groups(List groups)** - вызывает метод у клиентов групп **User(string userId)** - вызывает метод у пользователя по id **Users(List Ids)** - вызывает метод у пользователей c ids

---

### IHubContext

Класс Hub - не единственное место, где мы можем отправлять сообщения клиентам. SignalR позволяет это делать также в контроллерах, страницах Razor Pages, компонентах middleware, сервисах благодаря внедрению зависимости IHubContext.

Объект IHubContext реализует часть функциональности стандартного класса Hub, в частности, в нем определены такие же свойства Groups и Clients, которые позволяют манипулировать группами и отправлять сообщения всем подключенным клиентам

Однако стоит отметить, что данный способ отправки сообщений клиентам имее некоторые недостатки. Например, у свойства Clients доступно только свойство All - то есть мы можем отправить сообщение только всем клиентам и нету таких свойств как Other или Caller, которые доступны при использовании в классе хаба.

Также мы не можем получить из IHubContext id подключения. Поэтому если нам потребуется в контроллерах или других классах получить id подключения, то его можно получить при подключении на клиенте и затем пересылать тем или иным образом, например, через куки или через параметры запроса.