Компиляторы и средства предоставляют функциональные возможности среды CLR и позволяют писать код, который использует управляемую среду выполнения. Код, разработанный с использованием языкового компилятора для среды выполнения, называют управляемым.

В нем используются преимущества таких средств, как объединение языков программирования, объединенная обработка исключений, усиленная безопасность, поддержка отслеживания версий и развертывания, упрощенная модель взаимодействия компонентов, а также службы отладки и профилирования.

Языковые компиляторы должны предоставлять метаданные с описанием типов, членов и ссылок в коде. Метаданные хранятся вместе с кодом. Они содержатся в каждом загружаемом переносимом исполняемом (PE) файле среды CLR.

Метаданные в среде выполнения используются для поиска и загрузки классов, размещения экземпляров в памяти, разрешения имен при вызове методов, создания машинного кода, обеспечения безопасности и установки границ контекста выполнения.

>[!info] Примечание
> Поведение объектов разных языков CLR может быть тесно интегрировано. 
> Такая межязыковая интеграция возможна, так как языковые компиляторы и средства, предназначенные для среды выполнения, используют систему общих типов, определенную средой выполнения. Они следуют правилам среды выполнения для определения новых типов, а также для создания, использования, сохранения и привязки к типам.

В составе своих метаданных все управляемые компоненты содержат сведения о компонентах и ресурсах, на базе которых они построены. Среда выполнения использует эти сведения, чтобы обеспечить наличие всех необходимых ресурсов для компонента или приложения.

>[!tip] Common Type System
>
>Часть dotnet, формальная спецификация, определяющая, как какой-либо тип класс, интерфейс, структура, встроенный тип данных должен быть определён для его правильного выполнения средой .

>[!tip] Common Language System
>
>Спецификация CLS определяет набор функций, необходимых многим распространенным приложениям. Она также предоставляет своего рода перечень компонентов, которые должен поддерживать любой язык, реализуемый .NET
>
>Спецификация CLS является подмножеством системы CTS. Это означает, что все правила в CTS применяются и к CLS. То есть CLS помимо типов, описывает еще и API взаимодействия с этими типами для конкретной среды выполнения.
>
>Если компонент создается с использованием только правил CLS, то есть предоставляет в своем API только функции CLS, он считается CLS-совместимым.

---
#### Управляемое исполнение

#### 1) Выбор компилятора

Чтобы воспользоваться преимуществами, предоставляемыми средой CLR, необходимо применить один или несколько языковых компиляторов, ориентированных на среду выполнения

Поскольку среда выполнения является многоязычной, она поддерживает широкий набор разнообразных типов данных и языковых средств. Доступные средства среды выполнения определяются используемым языковым компилятором, и разработчики создают код с использованием этих средств.

Если компонент должен быть полностью доступен для компонентов, написанных на других языках, то экспортируемые этим компонентом типы должны предоставлять исключительно языковые функции, включенные в состав спецификации CLS. 

**CLSCompliantAttribute** - aтрибут гарантирующий, что код является CLS-совместимым.

#### 2) Компиляция в MSIL

При компиляции в управляемый код компилятор преобразует исходный код в промежуточный язык MSIL, представляющий собой независимый от процессора набор инструкций, который можно эффективно преобразовать в машинный код.

Язык MSIL включает инструкции для загрузки, сохранения, инициализации и вызова методов для объектов, а также инструкции для арифметических и логических операций, потоков управления, прямого доступа к памяти, обработки исключений.

Перед выполнением код MSIL необходимо преобразовать в код для конкретного процессора, обычно с помощью JIT-компилятора. Поскольку среда CLR предоставляет для каждой поддерживаемой компьютерной архитектуры один или несколько JIT-компиляторов, один набор инструкций MSIL можно компилировать и выполнять в любой поддерживаемой архитектуре.

Когда компилятор создает код MSIL, одновременно создаются метаданные. Метаданные содержат описание типов в коде, включая определение каждого типа, сигнатуры каждого члена типа, члены, на которые есть ссылки в коде, а также другие сведения, используемые средой выполнения во время выполнения.

#### 3) Компиляция в машинный код

При JIT-компиляции язык MSIL преобразуется в машинный код во время выполнения приложения по требованию, когда загружается и выполняется содержимое сборки. 

Если управляемый код вызывает специфический для платформы машинный API или библиотеку, то он будет выполняться только в соответствующей операционной системе.

При JIT-компиляции учитывается возможность того, что определенный код может никогда не вызываться во время выполнения. MSIL преобразуется в машинный код по мере необходимости во время выполнения. Машинный код сохраняется в памяти, что позволяет использовать его при дальнейших вызовах в контексте этого процесса.

Загрузчик создает и присоединяет заглушки к каждому методу в типе, когда тип загружается и инициализируется. При первом вызове метода заглушка передает управление JIT-компилятору, который преобразует MSIL для этого метода в машинный код и заменяет заглушку на созданный машинный код. Поэтому последующие вызовы метода, скомпилированного JIT, ведут непосредственно к машинному коду.

---

Тот факт, что JIT-компилятор преобразует MSIL-код сборки в машинный код при вызове отдельных методов, определенных в этой сборке, отрицательно сказывается на производительности во время выполнения.

В большинстве случаев снижение производительности приемлемо. Что более важно, код, созданный JIT-компилятором, будет привязан к процессу, вызвавшему компиляцию. Его нельзя сделать общим для нескольких процессов. 

Чтобы созданный код можно было использовать в нескольких вызовах приложения или в нескольких процессах, которые совместно используют набор сборок, среда CLR предоставляет режим предварительной компиляции. В таком режиме компиляции для преобразования сборок MSIL в машинный код в стиле JIT-компилятора используется генератор образов в машинном коде Ngen.exe для DotNet и CrossGen для DotNetCore.

